---
- name: Setup environment
  hosts: app1
  become: true
  vars: 
   packages:
     - git
     - python3.12-venv
  tasks:
    - name: update packages in ubuntu deploy server
      apt:
        update_cache: yes

    - name: upgrade packages in ubuntu deploy server
      apt:
        upgrade: yes
        
    - name: Install packages in ubuntu deploy server
      apt:
        name: "{{ packages }}"
        state: present

    - name: git clone the repository
      git:
        repo: https://github.com/TWhilst/Flask-monitoring-dashboard.git
        version: main
        single_branch: true
        dest: /home/ubuntu/flask
    
    # this is used to setup the python virtual environment for python and pip commands
    - name: Setup python virtual environment
      shell:  |
        python3 -m venv /home/ubuntu/env/teton
        source /home/ubuntu/env/teton/bin/activate
      # it is important to use bin/bash as the shell to ensure the virtual environment is activated correctly
      args:
        executable: /bin/bash
    
    - name: Install flask and run the python app
      shell: |
        cd flask
        pip install -r requirements.txt
        python app.py
      args:
        executable: /bin/bash

